name: Auto Label PRs

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        continue-on-error: true

      - name: Apply labels based on files changed
        uses: actions/github-script@v8
        with:
          script: |
            const changedFiles = '${{ steps.changed-files.outputs.all_changed_files }}'.split(' ');
            const labels = new Set();

            for (const file of changedFiles) {
              if (file.startsWith('symphonic_cipher/')) labels.add('core');
              if (file.startsWith('tests/') || file.includes('test_')) labels.add('tests');
              if (file.startsWith('.github/')) labels.add('ci/cd');
              if (file.startsWith('docs/') || file.endsWith('.md')) labels.add('documentation');
              if (file.startsWith('aetherauth/')) labels.add('aetherauth');
              if (file.startsWith('prototype/')) labels.add('prototype');
              if (file.startsWith('src/')) labels.add('typescript');
              if (file.endsWith('.py')) labels.add('python');
              if (file.endsWith('.ts') || file.endsWith('.tsx')) labels.add('typescript');
              if (file.includes('security') || file.includes('auth')) labels.add('security');
              if (file.includes('pqc') || file.includes('quantum')) labels.add('quantum');
            }

            // Add size labels
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            if (pr.additions + pr.deletions < 10) labels.add('size/XS');
            else if (pr.additions + pr.deletions < 50) labels.add('size/S');
            else if (pr.additions + pr.deletions < 200) labels.add('size/M');
            else if (pr.additions + pr.deletions < 500) labels.add('size/L');
            else labels.add('size/XL');

            if (labels.size > 0) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: Array.from(labels)
                });
                console.log('Labels applied:', Array.from(labels));
              } catch (e) {
                console.log('Could not apply labels:', e.message);
              }
            }
