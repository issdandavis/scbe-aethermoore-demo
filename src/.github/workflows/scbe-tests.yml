name: SCBE-AETHERMOORE Tests

on:
  push:
    branches: [ main, master, 'claude/**' ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install numpy scipy pytest

    - name: Run QASI Core Self-Test (Axiom Verification)
      run: |
        python symphonic_cipher/scbe_aethermoore/qasi_core.py

    - name: Run 14-Layer Pipeline Tests
      run: |
        python -m pytest symphonic_cipher/tests/test_fourteen_layer.py -v --tb=short

    - name: Run CPSE Physics Tests
      run: |
        python -m pytest symphonic_cipher/tests/test_cpse_physics.py -v --tb=short

    - name: Run Full System Tests
      run: |
        python -m pytest symphonic_cipher/tests/test_full_system.py -v --tb=short

    - name: Run Mathematical Theorem Verification
      run: |
        python -c "
        from symphonic_cipher.scbe_aethermoore.proofs_verification import (
            verify_theorem_1_1, verify_theorem_2_1, verify_theorem_3_1,
            verify_theorem_4_1, verify_theorem_5_1, verify_theorem_6_1,
            verify_theorem_7_1, verify_theorem_7_2, verify_theorem_8_1,
            verify_theorem_9_1, verify_theorem_10_1, verify_theorem_12_1,
            verify_theorem_15_2
        )

        theorems = [
            ('1.1', verify_theorem_1_1),
            ('2.1', verify_theorem_2_1),
            ('3.1', verify_theorem_3_1),
            ('4.1', verify_theorem_4_1),
            ('5.1', verify_theorem_5_1),
            ('6.1', verify_theorem_6_1),
            ('7.1', verify_theorem_7_1),
            ('7.2', verify_theorem_7_2),
            ('8.1', verify_theorem_8_1),
            ('9.1', verify_theorem_9_1),
            ('10.1', verify_theorem_10_1),
            ('12.1', verify_theorem_12_1),
            ('15.2', verify_theorem_15_2),
        ]

        print('THEOREM VERIFICATION')
        print('=' * 50)
        passed = 0
        for name, func in theorems:
            ok, details = func()
            status = '✓' if ok else '✗'
            print(f'  Theorem {name}: {status}')
            if ok:
                passed += 1

        print(f'\nResult: {passed}/13 theorems verified')
        assert passed == 13, f'Only {passed}/13 theorems passed!'
        "

    - name: Validate CPSE Axioms C1-C3
      run: |
        python -c "
        from symphonic_cipher.scbe_aethermoore.cpse_integrator import CPSESCBEIntegrator
        import random

        integrator = CPSESCBEIntegrator()
        violations = 0

        for _ in range(1000):
            r = integrator.integrate(
                delay=random.random(),
                cost=10 ** (random.random() * 15),
                soliton_gain=random.random(),
                spin_angle_deg=random.random() * 90,
                flux_var=random.random() * 100,
                d_tri_normalized=random.random()
            )
            if not (0 <= r.state.tau_eff <= 1): violations += 1
            if not (0 <= r.state.d_star_eff <= integrator.d_max): violations += 1
            if not (0 <= r.state.C_spin_eff <= 1): violations += 1
            if not (0 <= r.state.S_spec_eff <= 1): violations += 1
            if not (0 <= r.state.S_audio_eff <= 1): violations += 1

        print(f'CPSE Axioms C1-C3: {violations}/5000 violations')
        assert violations == 0, f'{violations} axiom violations detected!'
        print('All CPSE axioms validated ✓')
        "

  harmonic-scaling:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install numpy scipy pytest

    - name: Run Harmonic Scaling Tests
      run: |
        python -m pytest symphonic_cipher/tests/test_harmonic_scaling.py -v --tb=short -x
      timeout-minutes: 10

  core-cipher:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install numpy scipy pytest

    - name: Run Core Cipher Tests
      run: |
        python -m pytest symphonic_cipher/tests/test_core.py -v --tb=short
